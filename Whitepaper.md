# Watcher V1 – Architecture & Capabilities

**Watcher** is a lightweight log analysis and response framework designed for Linux servers. It is engineered to monitor system and service logs in real-time, identify hostile behavior, and respond dynamically using ipsets and xtables. Watcher V1 is stable and production-grade but considered a **dead-end** branch due to the deprecation of iptables/xtables in RHEL 10 and future distributions.

---

## Key Characteristics

- **Platform Focus**:  
  Developed on RHEL-9 clone AlmaLinux-9. Verified on Linux distributions like Debian 12 and Ubuntu Server 24. Not compatible with classical UNIX systems (e.g., AIX, HPUX, Solaris) due to reliance on tmpfs-based RAM disk setups.
  SuSE-Linux 15 [SLES; Leap] is not guaranteed to work with revision 1.4, since only BASH4 is provided in such distributions. 

- **Service-Agnostic Log Scanner**:  
  Watcher does *not* manipulate or interfere with service traffic directly. It only parses logs generated by system services (e.g., MTA, IMAP/POP, web services) and identifies patterns of abuse or anomaly.

- **IPSET-Based Blocking**:  
  Offenders are collected and managed via dynamic ipsets. These are applied using standard iptables/xtables mechanisms to minimize CPU overhead and maximize filtering performance.

- **Decentralized Module Architecture**:  
  Individual modules (e.g., `WatchMX`, `WatchMB`, `WatchLG`) operate semi-autonomously, loading runtime parameters from a central `watchermap.conf` generated at startup.

- **Single-Reader FIFO Design**:  
  To avoid contention in log parsing, only one module (typically the MX scanner) acts as FIFO reader for the `mail` facility, passing relevant lines to other consumers via internal pipes or dispatch rules.

- **SQLite-Backed State Engine**:  
  All persistent offender tracking is handled via lightweight SQLite databases stored on RAM disk for ultra-fast access. This eliminates the need for linear file reads/writes, even at scale.

---

## Design Objectives

- **Predictable Runtime Performance**:  
  Use of SQLite on RAM disk and strict avoidance of linear file operations ensures constant-time behavior as offender lists grow.

- **Event-Oriented DB Schema**:  
  The schema maintains historical context (`affairs`, `origin`, `event_date`, etc.) per IP, enabling modular analysis and rule-based escalation.

- **Adaptive Expiration Logic**:  
  Timeout policies differ based on the origin and severity of an entry, e.g., default expiry after 30 days, or 90 days for known repeat offenders.

- **No External Dependencies**:  
  All required binaries (e.g., `awk`, `date`, `dig`, `sqlite3`) are bundled into a self-contained RAM-based toolset, ensuring consistent behavior across platforms.

- **Stateless Firewall Interface**:  
  Watcher doesn't alter the system firewall itself. It only manages ipsets that are expected to be referenced by existing DROP rules in the active xtables config.

---

## Operational Notes

- **Startup Sequence**:  
  On startup, Watcher generates a full runtime map (`watchermap.conf`), populates RAM-based toolchains, and initializes module-local `RUNTIME` environments.

- **Modular Rule Dispatching**:  
  Offense patterns are defined via shell rule scripts (e.g., `*.rule` files). These map regex matches to rule categories and determine the dispatch chain.

- **Shared Database Across Modules**:  
  Modules share offender data via a common SQLite backend and tag entries with their origin to avoid duplication or conflict.

- **Log Forwarding/Delegation**:  
  Logs from services that co-log into the same facility (e.g., SMTP and IMAP) are selectively dispatched to the appropriate analysis module.

---

## Limitations

- **No firewalld/nftables Support**:  
  Watcher V1 is strictly xtables-based. Support for firewalld and nftables will only exist in Watcher-II (v2.x).

- **No GUI or External API**:  
  Watcher V1 is fully CLI-driven. There is no supervisor daemon, API endpoint, or interactive frontend.

- **Non-Portable to UNIX Variants**:  
  Due to its reliance on GNU tools, bash 5+, awk 5+, and tmpfs, it is not portable to traditional UNIX environments.

---

## Lifecycle & Future

Watcher V1 is considered **functionally frozen**. No architectural changes or feature additions are planned. Its successor, **Watcher-II**, is being rewritten to support nftables, firewalld integration, and a supervisory layer.

---

© 2025 – Watcher is developed and maintained by ComServe IT Services.  
This document reflects the state and scope of Watcher V1 as of its final production release.
